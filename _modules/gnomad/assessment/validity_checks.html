<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>gnomad.assessment.validity_checks &mdash; gnomad master documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            gnomad
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resource_sources.html">Resource Sources</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/broadinstitute/gnomad_methods/releases">Change Log</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">gnomad</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">gnomad.assessment.validity_checks</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for gnomad.assessment.validity_checks</h1><div class="highlight"><pre>
<span></span><span class="c1"># noqa: D100</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span><span class="p">,</span> <span class="n">redirect_stdout</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">hail</span> <span class="k">as</span> <span class="nn">hl</span>
<span class="kn">from</span> <span class="nn">hail.utils.misc</span> <span class="kn">import</span> <span class="n">new_temp_file</span>

<span class="kn">from</span> <span class="nn">gnomad.resources.grch38.gnomad</span> <span class="kn">import</span> <span class="n">CURRENT_MAJOR_RELEASE</span><span class="p">,</span> <span class="n">GEN_ANC_GROUPS</span><span class="p">,</span> <span class="n">SEXES</span>
<span class="kn">from</span> <span class="nn">gnomad.utils.vcf</span> <span class="kn">import</span> <span class="n">HISTS</span><span class="p">,</span> <span class="n">SORT_ORDER</span><span class="p">,</span> <span class="n">make_label_combos</span>

<span class="c1"># Save original LogRecord factory, i.e. the original logger.</span>
<span class="n">old_factory</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogRecordFactory</span><span class="p">()</span>


<span class="c1"># Define custom factory that appends function names to logger so we can</span>
<span class="c1"># parse them for the validation&#39;s output table.</span>
<div class="viewcode-block" id="custom_record_factory"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.custom_record_factory">[docs]</a><span class="k">def</span> <span class="nf">custom_record_factory</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a custom LogRecord factory that appends a given suffix to function names.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Create original log record.</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">old_factory</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Append suffix to original log record for future parsing.</span>
        <span class="n">record</span><span class="o">.</span><span class="n">funcName</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">funcName</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">record</span>

    <span class="k">return</span> <span class="n">factory</span></div>


<span class="c1"># Define context manager to temporarily enable the custom factory.</span>
<div class="viewcode-block" id="temp_logger"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.temp_logger">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">temp_logger</span><span class="p">(</span><span class="n">function_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Temporarily modify logging factory to append `function_name` to function names.&quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">setLogRecordFactory</span><span class="p">(</span><span class="n">custom_record_factory</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>
    <span class="k">yield</span>
    <span class="c1"># Restore original factory.</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">setLogRecordFactory</span><span class="p">(</span><span class="n">old_factory</span><span class="p">)</span></div>


<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2"> (</span><span class="si">%(name)s</span><span class="s2"> </span><span class="si">%(module)s</span><span class="s2">.</span><span class="si">%(funcName)s</span><span class="s2"> </span><span class="si">%(lineno)d</span><span class="s2">): </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<div class="viewcode-block" id="generic_field_check"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.generic_field_check">[docs]</a><span class="k">def</span> <span class="nf">generic_field_check</span><span class="p">(</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
    <span class="n">check_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">display_fields</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">StructExpression</span><span class="p">,</span>
    <span class="n">cond_expr</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">BooleanExpression</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">show_percent_sites</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">n_fail</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ht_count</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">function_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check generic logical condition `cond_expr` involving annotations in a Hail Table when `n_fail` is absent and print the results to stdout.</span>

<span class="sd">    Displays the number of rows (and percent of rows, if `show_percent_sites` is True) in the Table that fail, either previously computed as `n_fail` or that match the `cond_expr`, and fail to be the desired condition (`check_description`).</span>
<span class="sd">    If the number of rows that match the `cond_expr` or `n_fail` is 0, then the Table passes that check; otherwise, it fails.</span>

<span class="sd">    .. note::</span>

<span class="sd">        `cond_expr` and `check_description` are opposites and should never be the same.</span>
<span class="sd">        E.g., If `cond_expr` filters for instances where the raw AC is less than adj AC,</span>
<span class="sd">        then it is checking sites that fail to be the desired condition (`check_description`)</span>
<span class="sd">        of having a raw AC greater than or equal to the adj AC.</span>

<span class="sd">    :param ht: Table containing annotations to be checked.</span>
<span class="sd">    :param check_description: String describing the condition being checked; is displayed in stdout summary message.</span>
<span class="sd">    :param display_fields: StructExpression containing annotations to be displayed in case of failure (for troubleshooting purposes); these fields are also displayed if verbose is True.</span>
<span class="sd">    :param cond_expr: Optional logical expression referring to annotations in ht to be checked.</span>
<span class="sd">    :param verbose: If True, show top values of annotations being checked, including checks that pass; if False, show only top values of annotations that fail checks.</span>
<span class="sd">    :param show_percent_sites: Show percentage of sites that fail checks. Default is False.</span>
<span class="sd">    :param n_fail: Optional number of sites that fail the conditional checks (previously computed). If not supplied, `cond_expr` is used to filter the Table and obtain the count of sites that fail the checks.</span>
<span class="sd">    :param ht_count: Optional number of sites within hail Table (previously computed). If not supplied, a count of sites in the Table is performed.</span>
<span class="sd">    :param function_name: Name of the function that initiated this check. The name will be appended to the logger output.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">temp_logger</span><span class="p">(</span><span class="n">function_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n_fail</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cond_expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one of n_fail or cond_expr must be defined!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_fail</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cond_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_fail</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cond_expr</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">show_percent_sites</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ht_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ht_count</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">n_fail</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">table_output</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">cond_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ht_filtered</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">_fail</span><span class="o">=</span><span class="n">cond_expr</span><span class="p">,</span> <span class="o">**</span><span class="n">display_fields</span><span class="p">)</span>
                <span class="n">ht_filtered</span> <span class="o">=</span> <span class="n">ht_filtered</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ht_filtered</span><span class="o">.</span><span class="n">_fail</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;_fail&quot;</span><span class="p">)</span>
                <span class="c1"># Use StringIO to capture the table from show() for display in the final</span>
                <span class="c1"># output table.</span>
                <span class="n">log_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">log_stream</span><span class="p">):</span>
                    <span class="n">ht_filtered</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
                    <span class="n">table_output</span> <span class="o">=</span> <span class="n">log_stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">show_percent_sites</span><span class="p">:</span>
                <span class="n">percent_failed</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_fail</span> <span class="o">/</span> <span class="n">ht_count</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">percent_failed_log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">percent_failed</span><span class="si">}</span><span class="s2">%)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">percent_failed_log</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> sites</span><span class="si">%s</span><span class="s2"> that fail </span><span class="si">%s</span><span class="s2"> check: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">n_fail</span><span class="p">,</span>
                <span class="n">percent_failed_log</span><span class="p">,</span>
                <span class="n">check_description</span><span class="p">,</span>
                <span class="n">table_output</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">table_output</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">log_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">log_stream</span><span class="p">):</span>
                    <span class="n">ht</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">**</span><span class="n">display_fields</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
                    <span class="n">table_output</span> <span class="o">=</span> <span class="n">log_stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;PASSED </span><span class="si">%s</span><span class="s2"> check</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">check_description</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;:</span><span class="se">\n</span><span class="si">{</span><span class="n">table_output</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">table_output</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="generic_field_check_loop"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.generic_field_check_loop">[docs]</a><span class="k">def</span> <span class="nf">generic_field_check_loop</span><span class="p">(</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
    <span class="n">field_check_expr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">show_percent_sites</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ht_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">function_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loop through all conditional checks for a given hail Table.</span>

<span class="sd">    This loop allows aggregation across the hail Table once, as opposed to aggregating during every conditional check.</span>

<span class="sd">    :param ht: Table containing annotations to be checked.</span>
<span class="sd">    :param field_check_expr: Dictionary whose keys are conditions being checked and values are the expressions for filtering to condition.</span>
<span class="sd">    :param verbose: If True, show top values of annotations being checked, including checks that pass; if False, show only top values of annotations that fail checks.</span>
<span class="sd">    :param show_percent_sites: Show percentage of sites that fail checks. Default is False.</span>
<span class="sd">    :param ht_count: Previously computed sum of sites within hail Table. Default is None.</span>
<span class="sd">    :param function_name: Name of the function that initiated this check. The name will be appended to the logger output.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ht_field_check_counts</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
        <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;agg_func&quot;</span><span class="p">](</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;expr&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">field_check_expr</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">check_description</span><span class="p">,</span> <span class="n">n_fail</span> <span class="ow">in</span> <span class="n">ht_field_check_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">generic_field_check</span><span class="p">(</span>
            <span class="n">ht</span><span class="p">,</span>
            <span class="n">check_description</span><span class="o">=</span><span class="n">check_description</span><span class="p">,</span>
            <span class="n">n_fail</span><span class="o">=</span><span class="n">n_fail</span><span class="p">,</span>
            <span class="n">display_fields</span><span class="o">=</span><span class="n">field_check_expr</span><span class="p">[</span><span class="n">check_description</span><span class="p">][</span><span class="s2">&quot;display_fields&quot;</span><span class="p">],</span>
            <span class="n">cond_expr</span><span class="o">=</span><span class="n">field_check_expr</span><span class="p">[</span><span class="n">check_description</span><span class="p">][</span><span class="s2">&quot;expr&quot;</span><span class="p">],</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">show_percent_sites</span><span class="o">=</span><span class="n">show_percent_sites</span><span class="p">,</span>
            <span class="n">ht_count</span><span class="o">=</span><span class="n">ht_count</span><span class="p">,</span>
            <span class="n">function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="generate_field_check_expr"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.generate_field_check_expr">[docs]</a><span class="k">def</span> <span class="nf">generate_field_check_expr</span><span class="p">(</span>
    <span class="n">left_expr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">NumericExpression</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">StringExpression</span><span class="p">],</span>
    <span class="n">right_expr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">NumericExpression</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">StringExpression</span><span class="p">],</span>
    <span class="n">operator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">BooleanExpression</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a Hail expression to check field comparisons while handling missing values.</span>

<span class="sd">    If both fields are missing, the retured expression will be False. If only one field</span>
<span class="sd">    is missing, the expression will be True. If both fields are defined and not equal,</span>
<span class="sd">    the expression will be True.</span>

<span class="sd">    :param left_expr: Left expression field for comparison.</span>
<span class="sd">    :param right_expr: Right expression field for comparison.</span>
<span class="sd">    :param operator: Comparison operator as a string (&quot;==&quot;, &quot;!=&quot;, &quot;&lt;&quot;, &quot;&lt;=&quot;, &quot;&gt;&quot;, &quot;&gt;=&quot;).</span>
<span class="sd">    :return: Hail conditional expression for field validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">operators_exprs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;==&quot;</span><span class="p">:</span> <span class="n">left_expr</span> <span class="o">==</span> <span class="n">right_expr</span><span class="p">,</span>
        <span class="s2">&quot;!=&quot;</span><span class="p">:</span> <span class="n">left_expr</span> <span class="o">!=</span> <span class="n">right_expr</span><span class="p">,</span>
        <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span> <span class="n">left_expr</span> <span class="o">&lt;</span> <span class="n">right_expr</span><span class="p">,</span>
        <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span> <span class="n">left_expr</span> <span class="o">&lt;=</span> <span class="n">right_expr</span><span class="p">,</span>
        <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="n">left_expr</span> <span class="o">&gt;</span> <span class="n">right_expr</span><span class="p">,</span>
        <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="n">left_expr</span> <span class="o">&gt;=</span> <span class="n">right_expr</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">operator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">operators_exprs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported operator &#39;</span><span class="si">{</span><span class="n">operator</span><span class="si">}</span><span class="s2">&#39;. Choose from: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">operators_exprs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">hl</span><span class="o">.</span><span class="n">case</span><span class="p">()</span>
        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">left_expr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">right_expr</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">left_expr</span><span class="p">)</span> <span class="o">|</span> <span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">right_expr</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">operators_exprs</span><span class="p">[</span><span class="n">operator</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="make_filters_expr_dict"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.make_filters_expr_dict">[docs]</a><span class="k">def</span> <span class="nf">make_filters_expr_dict</span><span class="p">(</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
    <span class="n">extra_filter_checks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">Expression</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">variant_filter_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RF&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">Expression</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make Hail expressions to measure % variants filtered under varying conditions of interest.</span>

<span class="sd">    Checks for:</span>
<span class="sd">        - Total number of variants</span>
<span class="sd">        - Fraction of variants removed due to:</span>
<span class="sd">            - Any filter</span>
<span class="sd">            - Inbreeding coefficient filter in combination with any other filter</span>
<span class="sd">            - AC0 filter in combination with any other filter</span>
<span class="sd">            - `variant_filter_field` filtering in combination with any other filter</span>
<span class="sd">            - Only inbreeding coefficient filter</span>
<span class="sd">            - Only AC0 filter</span>
<span class="sd">            - Only filtering defined by `variant_filter_field`</span>

<span class="sd">    :param ht: Table containing &#39;filter&#39; annotation to be examined.</span>
<span class="sd">    :param extra_filter_checks: Optional dictionary containing filter condition name (key) extra filter expressions (value) to be examined.</span>
<span class="sd">    :param variant_filter_field: String of variant filtration used in the filters annotation on `ht` (e.g. RF, VQSR, AS_VQSR). Default is &quot;RF&quot;.</span>
<span class="sd">    :return: Dictionary containing Hail aggregation expressions to examine filter flags.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filters_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="s2">&quot;frac_any_filter&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">fraction</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">len</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;frac_inbreed_coeff&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">fraction</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;InbreedingCoeff&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;frac_ac0&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">fraction</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;AC0&quot;</span><span class="p">)),</span>
        <span class="sa">f</span><span class="s2">&quot;frac_</span><span class="si">{</span><span class="n">variant_filter_field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">fraction</span><span class="p">(</span>
            <span class="n">ht</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">variant_filter_field</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s2">&quot;frac_inbreed_coeff_only&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">fraction</span><span class="p">(</span>
            <span class="n">ht</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;InbreedingCoeff&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s2">&quot;frac_ac0_only&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">fraction</span><span class="p">(</span>
            <span class="n">ht</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;AC0&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="sa">f</span><span class="s2">&quot;frac_</span><span class="si">{</span><span class="n">variant_filter_field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_only&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">fraction</span><span class="p">(</span>
            <span class="n">ht</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">variant_filter_field</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">),</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">extra_filter_checks</span><span class="p">:</span>
        <span class="n">filters_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_filter_checks</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filters_dict</span></div>


<div class="viewcode-block" id="make_group_sum_expr_dict"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.make_group_sum_expr_dict">[docs]</a><span class="k">def</span> <span class="nf">make_group_sum_expr_dict</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
    <span class="n">subset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">label_groups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">sort_order</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">SORT_ORDER</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
    <span class="n">metric_first_field</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AC&quot;</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">,</span> <span class="s2">&quot;nhomalt&quot;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">Int64Expression</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">StructExpression</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the sum of call stats annotations for a specified group of annotations, compare to the annotated version, and display the result in stdout.</span>

<span class="sd">    For example, if subset1 consists of gen_anc1, gen_anc2, and gen_anc3, check that t.info.AC-subset1 == sum(t.info.AC-subset1-gen_anc1, t.info.AC-subset1-gen_anc2, t.info.AC-subset1-gen_anc3).</span>

<span class="sd">    :param t: Input MatrixTable or Table containing call stats annotations to be summed.</span>
<span class="sd">    :param subset: String indicating sample subset.</span>
<span class="sd">    :param label_groups: Dictionary containing an entry for each label group, where key is the name of the grouping, e.g. &quot;sex&quot; or &quot;gen_anc&quot;, and value is a list of all possible values for that grouping (e.g. [&quot;XY&quot;, &quot;XX&quot;] or [&quot;afr&quot;, &quot;nfe&quot;, &quot;amr&quot;]).</span>
<span class="sd">    :param sort_order: List containing order to sort label group combinations. Default is SORT_ORDER.</span>
<span class="sd">    :param delimiter: String to use as delimiter when making group label combinations. Default is &quot;_&quot;.</span>
<span class="sd">    :param metric_first_field: If True, metric precedes subset in the Table&#39;s fields, e.g. AC-hgdp. If False, subset precedes metric, hgdp-AC. Default is True.</span>
<span class="sd">    :param metrics: List of metrics to sum and compare to annotationed versions. Default is [&quot;AC&quot;, &quot;AN&quot;, &quot;nhomalt&quot;].</span>
<span class="sd">    :return: Dictionary of sample sum field check expressions and display fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span>

    <span class="c1"># Check if subset string is provided to avoid adding a delimiter to empty string</span>
    <span class="c1"># (An empty string is passed to run this check on the entire callset).</span>
    <span class="k">if</span> <span class="n">subset</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">+=</span> <span class="n">delimiter</span>

    <span class="n">label_combos</span> <span class="o">=</span> <span class="n">make_label_combos</span><span class="p">(</span><span class="n">label_groups</span><span class="p">,</span> <span class="n">label_delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">)</span>
    <span class="c1"># Grab the first group for check and remove if from the label_group</span>
    <span class="c1"># dictionary. In gnomAD, this is &#39;adj&#39;, as we do not retain the raw metric</span>
    <span class="c1"># counts for all sample groups so we do not check raw sample sums.</span>
    <span class="k">if</span> <span class="s2">&quot;group&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_groups</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">label_groups</span><span class="p">[</span><span class="s2">&quot;group&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Expected &#39;group&#39; key in label_groups but it&#39;s missing or empty.&quot;</span>
        <span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">label_groups</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># sum_group is a the type of high level annotation that you want to sum</span>
    <span class="c1"># e.g. &#39;gen_anc&#39;, &#39;gen_anc-sex&#39;, &#39;sex&#39;.</span>
    <span class="n">sum_group</span> <span class="o">=</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="nb">sorted</span><span class="p">(</span><span class="n">label_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sort_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">info_fields</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="c1"># Loop through metrics and the label combos to build a dictionary</span>
    <span class="c1"># where the key is a string representing the sum_group annotations and the value is the sum of these annotations.</span>
    <span class="c1"># If metric_first_field is True, metric is AC, subset is tgp, group is adj, sum_group is gen_anc, then the values below are:</span>
    <span class="c1"># sum_group_exprs = [&quot;AC-tgp-gen_anc1&quot;, &quot;AC-tgp-gen_anc2&quot;, &quot;AC-tgp-gen_anc3&quot;]</span>
    <span class="c1"># annot_dict = {&#39;sum-AC-tgp-adj-gen_anc&#39;: hl.sum([&quot;AC-tgp-adj-gen_anc1&quot;,</span>
    <span class="c1"># &quot;AC-tgp-adj-gen_anc2&quot;, &quot;AC-tgp-adj-gen_anc3&quot;])}</span>
    <span class="n">annot_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="n">field_prefix</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">subset</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">metric_first_field</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}{</span><span class="n">metric</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">sum_group_exprs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_combos</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_prefix</span><span class="si">}{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">info_fields</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Including field </span><span class="si">%s</span><span class="s2"> in make_group_sum_expr_dict.&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="n">sum_group_exprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is NOT in table&#39;s info field, it will NOT be included in make_group_sum_expr_dict.&quot;</span><span class="p">,</span>
                    <span class="n">field</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">sum_field_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sum</span><span class="si">{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">field_prefix</span><span class="si">}{</span><span class="n">group</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">sum_group</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sum_group_exprs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No valid fields found for </span><span class="si">%s</span><span class="s2">. Assigning hl.missing()&quot;</span><span class="p">,</span> <span class="n">sum_field_name</span>
            <span class="p">)</span>
            <span class="n">annot_dict</span><span class="p">[</span><span class="n">sum_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">missing</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">tint64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">annot_dict</span><span class="p">[</span><span class="n">sum_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sum_group_exprs</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">is_defined</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generated annot_dict keys: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">annot_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="c1"># If metric_first_field is True, metric is AC, subset is tgp, sum_group is gen_anc, and group is adj, then the values below are:</span>
    <span class="c1"># check_field_left = &quot;AC-tgp-adj&quot;</span>
    <span class="c1"># check_field_right = &quot;sum-AC-tgp-adj-gen_anc&quot; to match the annotation dict</span>
    <span class="c1"># key from above.</span>
    <span class="n">field_check_expr</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">metric_first_field</span><span class="p">:</span>
            <span class="n">check_field_left</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">subset</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check_field_left</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}{</span><span class="n">metric</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">check_field_right</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sum</span><span class="si">{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">check_field_left</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">sum_group</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">field_check_expr</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check_field_left</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">check_field_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">generate_field_check_expr</span><span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_left</span><span class="p">],</span> <span class="n">annot_dict</span><span class="p">[</span><span class="n">check_field_right</span><span class="p">],</span> <span class="s2">&quot;!=&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;agg_func&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">,</span>
            <span class="s2">&quot;display_fields&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="n">check_field_left</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_left</span><span class="p">],</span>
                    <span class="n">check_field_right</span><span class="p">:</span> <span class="n">annot_dict</span><span class="p">[</span><span class="n">check_field_right</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">),</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">field_check_expr</span></div>


<div class="viewcode-block" id="compare_row_counts"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.compare_row_counts">[docs]</a><span class="k">def</span> <span class="nf">compare_row_counts</span><span class="p">(</span><span class="n">ht1</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span> <span class="n">ht2</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the row counts in two Tables are the same.</span>

<span class="sd">    :param ht1: First Table to be checked.</span>
<span class="sd">    :param ht2: Second Table to be checked.</span>
<span class="sd">    :return: Whether the row counts are the same.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r_count1</span> <span class="o">=</span> <span class="n">ht1</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">r_count2</span> <span class="o">=</span> <span class="n">ht2</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> rows in left table; </span><span class="si">%d</span><span class="s2"> rows in right table&quot;</span><span class="p">,</span> <span class="n">r_count1</span><span class="p">,</span> <span class="n">r_count2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r_count1</span> <span class="o">==</span> <span class="n">r_count2</span></div>


<div class="viewcode-block" id="summarize_variant_filters"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.summarize_variant_filters">[docs]</a><span class="k">def</span> <span class="nf">summarize_variant_filters</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
    <span class="n">variant_filter_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RF&quot;</span><span class="p">,</span>
    <span class="n">problematic_regions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lcr&quot;</span><span class="p">,</span> <span class="s2">&quot;segdup&quot;</span><span class="p">,</span> <span class="s2">&quot;nonpar&quot;</span><span class="p">],</span>
    <span class="n">single_filter_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">site_gt_check_expr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">BooleanExpression</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_filter_checks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">Expression</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">n_cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">140</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Summarize variants filtered under various conditions in input MatrixTable or Table.</span>

<span class="sd">    Summarize counts for:</span>
<span class="sd">        - Total number of variants</span>
<span class="sd">        - Fraction of variants removed due to:</span>
<span class="sd">            - Any filter</span>
<span class="sd">            - Inbreeding coefficient filter in combination with any other filter</span>
<span class="sd">            - AC0 filter in combination with any other filter</span>
<span class="sd">            - `variant_filter_field` filtering in combination with any other filter in combination with any other filter</span>
<span class="sd">            - Only inbreeding coefficient filter</span>
<span class="sd">            - Only AC0 filter</span>
<span class="sd">            - Only `variant_filter_field` filtering</span>

<span class="sd">    :param t: Input MatrixTable or Table to be checked.</span>
<span class="sd">    :param variant_filter_field: String of variant filtration used in the filters annotation on `ht` (e.g. RF, VQSR, AS_VQSR). Default is &quot;RF&quot;.</span>
<span class="sd">    :param problematic_regions: List of regions considered problematic to run filter check in. Default is [&quot;lcr&quot;, &quot;segdup&quot;, &quot;nonpar&quot;].</span>
<span class="sd">    :param single_filter_count: If True, explode the Table&#39;s filter column and give a supplement total count of each filter. Default is False.</span>
<span class="sd">    :param site_gt_check_expr: Optional dictionary of strings and boolean expressions typically used to log how many monoallelic or 100% heterozygous sites are in the Table.</span>
<span class="sd">    :param extra_filter_checks: Optional dictionary containing filter condition name (key) and extra filter expressions (value) to be examined.</span>
<span class="sd">    :param n_rows: Number of rows to display only when showing percentages of filtered variants grouped by multiple conditions. Default is 50.</span>
<span class="sd">    :param n_cols: Number of columns to display only when showing percentages of filtered variants grouped by multiple conditions. Default is 140.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">filters</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Variant filter counts: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filters</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">single_filter_count</span><span class="p">:</span>
        <span class="n">exp_t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">exp_t</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span><span class="n">exp_t</span><span class="o">.</span><span class="n">filters</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exploded variant filter counts: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filters</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">site_gt_check_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m_expr</span> <span class="ow">in</span> <span class="n">site_gt_check_expr</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">):</span>
                <span class="n">gt_check_sites</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">filter_rows</span><span class="p">(</span><span class="n">m_expr</span><span class="p">)</span><span class="o">.</span><span class="n">count_rows</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gt_check_sites</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">m_expr</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;There are </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> sites in the dataset.&quot;</span><span class="p">,</span> <span class="n">gt_check_sites</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

    <span class="n">filtered_expr</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">problematic_region_expr</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">problematic_regions</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="n">is_filtered</span><span class="o">=</span><span class="n">filtered_expr</span><span class="p">,</span> <span class="n">in_problematic_region</span><span class="o">=</span><span class="n">problematic_region_expr</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_filter_agg_order</span><span class="p">(</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
        <span class="n">group_exprs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">Expression</span><span class="p">],</span>
        <span class="n">n_rows</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform validity checks to measure percentages of variants filtered under different conditions.</span>

<span class="sd">        :param t: Input MatrixTable or Table.</span>
<span class="sd">        :param group_exprs: Dictionary of expressions to group the Table by.</span>
<span class="sd">        :param extra_filter_checks: Optional dictionary containing filter condition name (key) and extra filter expressions (value) to be examined.</span>
<span class="sd">        :param n_rows: Number of rows to show. Default is None (to display 10 rows).</span>
<span class="sd">        :param n_cols: Number of columns to show. Default is None (to display 10 cols).</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span>
        <span class="c1"># NOTE: make_filters_expr_dict returns a dict with %ages of variants filtered</span>
        <span class="n">log_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">log_stream</span><span class="p">):</span>
            <span class="n">t</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="o">**</span><span class="n">group_exprs</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                <span class="o">**</span><span class="n">make_filters_expr_dict</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">extra_filter_checks</span><span class="p">,</span> <span class="n">variant_filter_field</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)</span>
            <span class="n">table_output</span> <span class="o">=</span> <span class="n">log_stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">table_output</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Checking distributions of filtered variants amongst variant filters...&quot;</span>
    <span class="p">)</span>
    <span class="n">summary_table</span> <span class="o">=</span> <span class="n">_filter_agg_order</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;is_filtered&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">is_filtered</span><span class="p">},</span> <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Distributions of filtered variants amongst variant filters: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">summary_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">add_agg_expr</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s2">&quot;allele_type&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking distributions of variant type amongst variant filters...&quot;</span><span class="p">)</span>
        <span class="n">add_agg_expr</span><span class="p">[</span><span class="s2">&quot;allele_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">allele_type</span>
        <span class="n">summary_table</span> <span class="o">=</span> <span class="n">_filter_agg_order</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">add_agg_expr</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Distributions of variant type amongst variant filters: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">summary_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;in_problematic_region&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Checking distributions of variant type and region type amongst variant&quot;</span>
            <span class="s2">&quot; filters...&quot;</span>
        <span class="p">)</span>
        <span class="n">add_agg_expr</span><span class="p">[</span><span class="s2">&quot;in_problematic_region&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">in_problematic_region</span>
        <span class="n">summary_table</span> <span class="o">=</span> <span class="n">_filter_agg_order</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">add_agg_expr</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Distributions of variant type and region amongst variant filters: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">summary_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;n_alt_alleles&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Checking distributions of variant type, region type, and number of alt alleles&quot;</span>
            <span class="s2">&quot; amongst variant filters...&quot;</span>
        <span class="p">)</span>
        <span class="n">add_agg_expr</span><span class="p">[</span><span class="s2">&quot;n_alt_alleles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">n_alt_alleles</span>
        <span class="n">summary_table</span> <span class="o">=</span> <span class="n">_filter_agg_order</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">add_agg_expr</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Distributions of variant type, region type, and number of alt alleles variant filters: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">summary_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="compare_subset_freqs"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.compare_subset_freqs">[docs]</a><span class="k">def</span> <span class="nf">compare_subset_freqs</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
    <span class="n">subsets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">show_percent_sites</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
    <span class="n">metric_first_field</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AC&quot;</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">,</span> <span class="s2">&quot;nhomalt&quot;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform validity checks on frequency data in input Table.</span>

<span class="sd">    Check:</span>
<span class="sd">        - Number of sites where callset frequency is equal to a subset frequency (raw and adj)</span>
<span class="sd">            - eg. t.info.AC-adj != t.info.AC-subset1-adj</span>
<span class="sd">        - Total number of sites where the raw allele count annotation is defined</span>

<span class="sd">    :param t: Input MatrixTable or Table.</span>
<span class="sd">    :param subsets: List of sample subsets.</span>
<span class="sd">    :param verbose: If True, show top values of annotations being checked, including checks that pass; if False, show only top values of annotations that fail checks.</span>
<span class="sd">    :param show_percent_sites: If True, show the percentage and count of overall sites that fail; if False, only show the number of sites that fail.</span>
<span class="sd">    :param delimiter: String to use as delimiter when making group label combinations. Default is &quot;_&quot;.</span>
<span class="sd">    :param metric_first_field: If True, metric precedes subset, e.g. AC-non_v2-. If False, subset precedes metric, non_v2-AC-XY. Default is True.</span>
<span class="sd">    :param metrics: List of metrics to compare between subset and entire callset. Default is [&quot;AC&quot;, &quot;AN&quot;, &quot;nhomalt&quot;].</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span>

    <span class="n">field_check_expr</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subset</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;adj&quot;</span><span class="p">,</span> <span class="s2">&quot;raw&quot;</span><span class="p">]:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Comparing the </span><span class="si">%s</span><span class="s2"> subset&#39;s </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> to entire callset&#39;s </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">subset</span><span class="p">,</span>
                        <span class="n">group</span><span class="p">,</span>
                        <span class="n">metric</span><span class="p">,</span>
                        <span class="n">group</span><span class="p">,</span>
                        <span class="n">metric</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">check_field_left</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">metric_first_field</span><span class="p">:</span>
                        <span class="n">check_field_right</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">subset</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">check_field_right</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">metric</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                    <span class="c1"># Check that either the left or right field is non-zero. If both are</span>
                    <span class="c1"># zero, do not need to flag the variant. If either is missing, will</span>
                    <span class="c1"># want to flag the variant.</span>
                    <span class="n">non_zero_condition</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">or_else</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_left</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="o">|</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_right</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="o">|</span> <span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_left</span><span class="p">])</span>
                        <span class="o">|</span> <span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_right</span><span class="p">]),</span>
                        <span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">field_check_expr</span><span class="p">[</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check_field_left</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">check_field_right</span><span class="si">}</span><span class="s2"> while non-zero&quot;</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">non_zero_condition</span>
                        <span class="o">&amp;</span> <span class="n">generate_field_check_expr</span><span class="p">(</span>
                            <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_left</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_right</span><span class="p">],</span> <span class="s2">&quot;==&quot;</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;agg_func&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">,</span>
                        <span class="s2">&quot;display_fields&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
                            <span class="o">**</span><span class="p">{</span>
                                <span class="n">check_field_left</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_left</span><span class="p">],</span>
                                <span class="n">check_field_right</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_right</span><span class="p">],</span>
                            <span class="p">}</span>
                        <span class="p">),</span>
                    <span class="p">}</span>

    <span class="n">generic_field_check_loop</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">field_check_expr</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">,</span>
        <span class="n">show_percent_sites</span><span class="o">=</span><span class="n">show_percent_sites</span><span class="p">,</span>
        <span class="n">function_name</span><span class="o">=</span><span class="s2">&quot;compare_subset_freqs&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Spot check the raw AC counts</span>
    <span class="n">total_defined_raw_ac</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
        <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">is_defined</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;AC</span><span class="si">{</span><span class="n">delimiter</span><span class="si">}</span><span class="s2">raw&quot;</span><span class="p">]))</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total defined raw AC count: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">total_defined_raw_ac</span><span class="p">)</span></div>


<div class="viewcode-block" id="sum_group_callstats"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.sum_group_callstats">[docs]</a><span class="k">def</span> <span class="nf">sum_group_callstats</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
    <span class="n">sexes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">SEXES</span><span class="p">,</span>
    <span class="n">subsets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span>
    <span class="n">gen_anc_groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">GEN_ANC_GROUPS</span><span class="p">[</span><span class="n">CURRENT_MAJOR_RELEASE</span><span class="p">][</span><span class="s2">&quot;exomes&quot;</span><span class="p">],</span>
    <span class="n">groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;adj&quot;</span><span class="p">],</span>
    <span class="n">additional_subsets_and_gen_anc_groups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sort_order</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">SORT_ORDER</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
    <span class="n">metric_first_field</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AC&quot;</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">,</span> <span class="s2">&quot;nhomalt&quot;</span><span class="p">],</span>
    <span class="n">gen_anc_label_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gen_anc&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the sum of annotations for a specified group of annotations, and compare to the annotated version.</span>

<span class="sd">    Displays results from checking the sum of the specified annotations in stdout.</span>
<span class="sd">    Also checks that annotations for all expected sample genetic ancestry groups are present.</span>

<span class="sd">    :param t: Input Table.</span>
<span class="sd">    :param sexes: List of sexes in table.</span>
<span class="sd">    :param subsets: List of sample subsets that contain genetic ancestry groups passed in gen_anc_groups parameter. An empty string, e.g. &quot;&quot;, should be passed to test entire callset. Default is [&quot;&quot;].</span>
<span class="sd">    :param gen_anc_groups: List of genetic ancestry groups contained within the subsets. Default is GEN_ANC_GROUPS[CURRENT_MAJOR_RELEASE][&quot;exomes&quot;].</span>
<span class="sd">    :param groups: List of callstat groups, e.g. &quot;adj&quot; and &quot;raw&quot; contained within the callset. gnomAD does not store the raw callstats for the genetic ancestry group or sex groupings of any subset. Default is [&quot;adj&quot;]</span>
<span class="sd">    :param additional_subsets_and_gen_anc_groups: Dict with subset (keys) and list of the subset&#39;s specific genetic ancestry groups (values). Default is None.</span>
<span class="sd">    :param verbose: If True, show top values of annotations being checked, including checks that pass; if False, show only top values of annotations that fail checks. Default is False.</span>
<span class="sd">    :param sort_order: List containing order to sort label group combinations. Default is SORT_ORDER.</span>
<span class="sd">    :param delimiter: String to use as delimiter when making group label combinations. Default is &quot;_&quot;.</span>
<span class="sd">    :param metric_first_field: If True, metric precedes label group, e.g. AC-afr-XY. If False, label group precedes metric, afr-XY-AC. Default is True.</span>
<span class="sd">    :param metrics: List of metrics to sum and compare to annotationed versions. Default is [&quot;AC&quot;, &quot;AN&quot;, &quot;nhomalt&quot;].</span>
<span class="sd">    :param gen_anc_label_name: Name of label used to denote genetic ancestry groups, such as &quot;gen_anc&quot; or &quot;pop&quot;. Default is &quot;gen_anc&quot;.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Add support for subgroup sums.</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span>

    <span class="n">field_check_expr</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">default_gen_anc_subset</span> <span class="o">=</span> <span class="p">{</span><span class="n">subset</span><span class="p">:</span> <span class="n">gen_anc_groups</span> <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">}</span>
    <span class="n">sample_sum_sets_and_gen_anc_groups</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">{</span><span class="o">**</span><span class="n">default_gen_anc_subset</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_subsets_and_gen_anc_groups</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">additional_subsets_and_gen_anc_groups</span>
        <span class="k">else</span> <span class="n">default_gen_anc_subset</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">subset</span><span class="p">,</span> <span class="n">gen_anc_groups</span> <span class="ow">in</span> <span class="n">sample_sum_sets_and_gen_anc_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">grouping</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">{</span><span class="n">gen_anc_label_name</span><span class="p">:</span> <span class="n">gen_anc_groups</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="n">sexes</span><span class="p">},</span>
                <span class="p">{</span><span class="n">gen_anc_label_name</span><span class="p">:</span> <span class="n">gen_anc_groups</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="n">sexes</span><span class="p">},</span>
            <span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Making group sum expression dictionary for grouping: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">grouping</span>
                <span class="p">)</span>
                <span class="n">field_check_expr_s</span> <span class="o">=</span> <span class="n">make_group_sum_expr_dict</span><span class="p">(</span>
                    <span class="n">t</span><span class="p">,</span>
                    <span class="n">subset</span><span class="p">,</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="o">**</span><span class="n">grouping</span><span class="p">),</span>
                    <span class="n">sort_order</span><span class="p">,</span>
                    <span class="n">delimiter</span><span class="p">,</span>
                    <span class="n">metric_first_field</span><span class="p">,</span>
                    <span class="n">metrics</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">field_check_expr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">field_check_expr_s</span><span class="p">)</span>
    <span class="n">generic_field_check_loop</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">field_check_expr</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">function_name</span><span class="o">=</span><span class="s2">&quot;sum_group_callstats&quot;</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="summarize_variants"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.summarize_variants">[docs]</a><span class="k">def</span> <span class="nf">summarize_variants</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
    <span class="n">expected_contigs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">hl</span><span class="o">.</span><span class="n">Struct</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get summary of variants in a MatrixTable or Table.</span>

<span class="sd">    Print the number of variants to stdout and check that each chromosome has variant calls. If requested,</span>
<span class="sd">    check that all expected contigs are found in the variant summary and that no unexpected contigs are found.</span>

<span class="sd">    :param t: Input MatrixTable or Table to be checked.</span>
<span class="sd">    :param expected_contigs: List of contigs expected to be found in the input.</span>
<span class="sd">    :return: Struct of variant summary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dataset has </span><span class="si">%d</span><span class="s2"> samples.&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">count_cols</span><span class="p">())</span>

    <span class="n">var_summary</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">summarize_variants</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Dataset has </span><span class="si">%d</span><span class="s2"> variants distributed across the following contigs: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">var_summary</span><span class="o">.</span><span class="n">n_variants</span><span class="p">,</span>
        <span class="n">var_summary</span><span class="o">.</span><span class="n">contigs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Check that all contigs have variant calls.</span>
    <span class="k">for</span> <span class="n">contig</span> <span class="ow">in</span> <span class="n">var_summary</span><span class="o">.</span><span class="n">contigs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">var_summary</span><span class="o">.</span><span class="n">contigs</span><span class="p">[</span><span class="n">contig</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no variants called&quot;</span><span class="p">,</span> <span class="n">var_summary</span><span class="o">.</span><span class="n">contigs</span><span class="p">)</span>

    <span class="c1"># Check that all expected contigs are found in the variant summary</span>
    <span class="c1"># and that no unexpected contigs are found.</span>
    <span class="k">if</span> <span class="n">expected_contigs</span><span class="p">:</span>
        <span class="n">var_summary_contigs</span> <span class="o">=</span> <span class="n">var_summary</span><span class="p">[</span><span class="s2">&quot;contigs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">missing_contigs</span> <span class="o">=</span> <span class="n">expected_contigs</span> <span class="o">-</span> <span class="n">var_summary_contigs</span>
        <span class="n">unexpected_contigs</span> <span class="o">=</span> <span class="n">var_summary_contigs</span> <span class="o">-</span> <span class="n">expected_contigs</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Expected contigs: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">expected_contigs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found contigs: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">var_summary_contigs</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">missing_contigs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;FAILED contig check, the following contigs are missing: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">missing_contigs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">unexpected_contigs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;FAILED contig check, the following contigs are unexpected: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">unexpected_contigs</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">var_summary</span></div>


<div class="viewcode-block" id="check_raw_and_adj_callstats"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.check_raw_and_adj_callstats">[docs]</a><span class="k">def</span> <span class="nf">check_raw_and_adj_callstats</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
    <span class="n">subsets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
    <span class="n">metric_first_field</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">nhomalt_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;nhomalt&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform validity checks on raw and adj data in input Table/MatrixTable.</span>

<span class="sd">    Check that:</span>
<span class="sd">        - Raw AC and AF are not 0</span>
<span class="sd">        - AC and AF are not negative</span>
<span class="sd">        - Raw values for AC, AN, nhomalt in each sample subset are greater than or equal to their corresponding adj values</span>

<span class="sd">    Raw and adj call stat annotations must be in an info struct annotation on the Table/MatrixTable, e.g. t.info.AC-raw.</span>

<span class="sd">    :param t: Input MatrixTable or Table to check.</span>
<span class="sd">    :param subsets: List of sample subsets.</span>
<span class="sd">    :param verbose: If True, show top values of annotations being checked, including checks that pass; if False, show only top values of annotations that fail checks.</span>
<span class="sd">    :param delimiter: String to use as delimiter when making group label combinations. Default is &quot;_&quot;.</span>
<span class="sd">    :param metric_first_field: If True, metric precedes label group, e.g. AC-afr-XY. If False, label group precedes metric, afr-XY-AC. Default is True.</span>
<span class="sd">    :param nhomalt_metric: Name of metric denoting homozygous alternate counts. Default is &quot;nhomalt&quot;.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span>

    <span class="n">field_check_expr</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="s2">&quot;adj&quot;</span><span class="p">]:</span>
        <span class="c1"># Check AC and nhomalt missing if AN is missing and defined if AN is defined.</span>
        <span class="k">for</span> <span class="n">subfield</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;AC&quot;</span><span class="p">,</span> <span class="n">nhomalt_metric</span><span class="p">]:</span>
            <span class="n">check_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subfield</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">an_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;AN</span><span class="si">{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">field_check_expr</span><span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check_field</span><span class="si">}</span><span class="s2"> defined when AN defined and missing when AN missing&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">if_else</span><span class="p">(</span>
                    <span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">an_field</span><span class="p">]),</span>
                    <span class="n">hl</span><span class="o">.</span><span class="n">is_defined</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field</span><span class="p">]),</span>
                    <span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field</span><span class="p">]),</span>
                <span class="p">),</span>
                <span class="s2">&quot;agg_func&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">,</span>
                <span class="s2">&quot;display_fields&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
                    <span class="o">**</span><span class="p">{</span><span class="n">an_field</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">an_field</span><span class="p">],</span> <span class="n">check_field</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field</span><span class="p">]}</span>
                <span class="p">),</span>
            <span class="p">}</span>

        <span class="c1"># Check that nhomalt &lt;= AC / 2.</span>
        <span class="n">check_field_nhomalt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nhomalt_metric</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">check_field_AC</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;AC</span><span class="si">{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">field_check_expr</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check_field_nhomalt</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">check_field_AC</span><span class="si">}</span><span class="s2"> / 2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_nhomalt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_AC</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;agg_func&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">,</span>
            <span class="s2">&quot;display_fields&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="n">check_field_nhomalt</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_nhomalt</span><span class="p">],</span>
                    <span class="n">check_field_AC</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_AC</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># Check AF missing if AN is missing and defined if AN is defined and &gt; 0.</span>
        <span class="n">check_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;AF</span><span class="si">{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">an_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;AN</span><span class="si">{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">field_check_expr</span><span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check_field</span><span class="si">}</span><span class="s2"> defined when AN defined (and &gt; 0) and missing when AN missing&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">if_else</span><span class="p">(</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">an_field</span><span class="p">]),</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">is_defined</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field</span><span class="p">]),</span>
                <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">an_field</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field</span><span class="p">]),</span>
            <span class="p">),</span>
            <span class="s2">&quot;agg_func&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">,</span>
            <span class="s2">&quot;display_fields&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span><span class="n">an_field</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">an_field</span><span class="p">],</span> <span class="n">check_field</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field</span><span class="p">]}</span>
            <span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># Check raw and adj AF missing if AN is 0.</span>
        <span class="n">check_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;AF</span><span class="si">{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">an_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;AN</span><span class="si">{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">field_check_expr</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check_field</span><span class="si">}</span><span class="s2"> missing when AN 0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">an_field</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">hl</span><span class="o">.</span><span class="n">is_defined</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field</span><span class="p">]),</span>
            <span class="s2">&quot;agg_func&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">,</span>
            <span class="s2">&quot;display_fields&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span><span class="n">an_field</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">an_field</span><span class="p">],</span> <span class="n">check_field</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field</span><span class="p">]}</span>
            <span class="p">),</span>
        <span class="p">}</span>

    <span class="k">for</span> <span class="n">subfield</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;AC&quot;</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">]:</span>
        <span class="c1"># If defined, check that raw AC, AF &gt; 0.</span>
        <span class="n">check_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subfield</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}</span><span class="s2">raw&quot;</span>
        <span class="n">field_check_expr</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check_field</span><span class="si">}</span><span class="s2"> &gt; 0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;agg_func&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">,</span>
            <span class="s2">&quot;display_fields&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">check_field</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field</span><span class="p">]}),</span>
        <span class="p">}</span>

        <span class="c1"># If defined, check adj AC, AF &gt;= 0.</span>
        <span class="n">check_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subfield</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}</span><span class="s2">adj&quot;</span>
        <span class="n">field_check_expr</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check_field</span><span class="si">}</span><span class="s2"> &gt;= 0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;agg_func&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">,</span>
            <span class="s2">&quot;display_fields&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span><span class="n">check_field</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field</span><span class="p">],</span> <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">filters</span><span class="p">}</span>
            <span class="p">),</span>
        <span class="p">}</span>

    <span class="c1"># Check overall gnomad&#39;s raw subfields &gt;= adj.</span>
    <span class="k">for</span> <span class="n">subfield</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;AC&quot;</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">,</span> <span class="n">nhomalt_metric</span><span class="p">]:</span>
        <span class="n">check_field_left</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subfield</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}</span><span class="s2">raw&quot;</span>
        <span class="n">check_field_right</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subfield</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}</span><span class="s2">adj&quot;</span>

        <span class="n">field_check_expr</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check_field_left</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">check_field_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_left</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_right</span><span class="p">],</span>
            <span class="s2">&quot;agg_func&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">,</span>
            <span class="s2">&quot;display_fields&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="n">check_field_left</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_left</span><span class="p">],</span>
                    <span class="n">check_field_right</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_right</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">),</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
            <span class="c1"># Add delimiter for subsets but not &quot;&quot; representing entire callset.</span>
            <span class="k">if</span> <span class="n">subset</span><span class="p">:</span>
                <span class="n">subset</span> <span class="o">+=</span> <span class="n">delimiter</span>
            <span class="n">field_check_label</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subfield</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}{</span><span class="n">subset</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">metric_first_field</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}{</span><span class="n">subfield</span><span class="si">}{</span><span class="n">delimiter</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">check_field_left</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_check_label</span><span class="si">}</span><span class="s2">raw&quot;</span>
            <span class="n">check_field_right</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_check_label</span><span class="si">}</span><span class="s2">adj&quot;</span>

            <span class="n">field_check_expr</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check_field_left</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">check_field_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">generate_field_check_expr</span><span class="p">(</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_left</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_right</span><span class="p">],</span> <span class="s2">&quot;&lt;&quot;</span>
                <span class="p">),</span>
                <span class="s2">&quot;agg_func&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">,</span>
                <span class="s2">&quot;display_fields&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
                    <span class="o">**</span><span class="p">{</span>
                        <span class="n">check_field_left</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_left</span><span class="p">],</span>
                        <span class="n">check_field_right</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_right</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">),</span>
            <span class="p">}</span>

    <span class="n">generic_field_check_loop</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">field_check_expr</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">function_name</span><span class="o">=</span><span class="s2">&quot;check_raw_and_adj_callstats&quot;</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="check_sex_chr_metrics"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.check_sex_chr_metrics">[docs]</a><span class="k">def</span> <span class="nf">check_sex_chr_metrics</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
    <span class="n">info_metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">contigs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
    <span class="n">nhomalt_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;nhomalt&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform validity checks for annotations on the sex chromosomes.</span>

<span class="sd">    Check:</span>
<span class="sd">        - That metrics for chrY variants in XX samples are NA and not 0</span>
<span class="sd">        - That nhomalt counts are equal to XX nhomalt counts for all non-PAR chrX variants</span>

<span class="sd">    :param t: Input MatrixTable or Table.</span>
<span class="sd">    :param info_metrics: List of metrics in info struct of input Table.</span>
<span class="sd">    :param contigs: List of contigs present in input Table.</span>
<span class="sd">    :param verbose: If True, show top values of annotations being checked, including checks that pass; if False, show only top values of annotations that fail checks.</span>
<span class="sd">    :param delimiter: String to use as the delimiter in XX metrics. Default is &quot;_&quot;.</span>
<span class="sd">    :param nhomalt_metric: Name of metric denoting homozygous alternate counts. Default is &quot;nhomalt&quot;.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span>

    <span class="n">xx_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">info_metrics</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">delimiter</span><span class="si">}</span><span class="s2">XX&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FAILED check for XX metrics: no XX metrics found!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking the following XX metrics: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xx_metrics</span><span class="p">)</span>

    <span class="c1"># Check that metrics for chrY variants in XX samples are NA and not 0.</span>
    <span class="k">if</span> <span class="s2">&quot;chrY&quot;</span> <span class="ow">in</span> <span class="n">contigs</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check values of XX metrics for Y variants are NA:&quot;</span><span class="p">)</span>
        <span class="n">t_y</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">filter_intervals</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">parse_locus_interval</span><span class="p">(</span>
                    <span class="s2">&quot;chrY&quot;</span><span class="p">,</span> <span class="n">reference_genome</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">locus</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">reference_genome</span>
                <span class="p">)</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="n">n_y</span> <span class="o">=</span> <span class="n">t_y</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">n_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FAILED metric checks on chrY: no Y variants found!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> chrY variants&quot;</span><span class="p">,</span> <span class="n">n_y</span><span class="p">)</span>
        <span class="n">metrics_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">xx_metrics</span><span class="p">:</span>
            <span class="n">metrics_values</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">is_defined</span><span class="p">(</span><span class="n">t_y</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">metric</span><span class="p">]))</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">t_y</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="o">**</span><span class="n">metrics_values</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">values_found</span> <span class="o">=</span> <span class="n">t_y</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                    <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">hl</span><span class="o">.</span><span class="n">is_defined</span><span class="p">(</span><span class="n">t_y</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">metric</span><span class="p">]),</span>
                        <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">t_y</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;FAILED </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2"> check for Y variants. Values found: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">metric</span><span class="p">,</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">values_found</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PASSED </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2"> check for Y variants&quot;</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FAILED metric checks on chrY: no chrY found!&quot;</span><span class="p">)</span>

    <span class="c1"># Check that nhomalt counts are equal to XX nhomalt counts for all non-PAR</span>
    <span class="c1"># chrX variants.</span>
    <span class="n">t_x</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">filter_intervals</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="n">hl</span><span class="o">.</span><span class="n">parse_locus_interval</span><span class="p">(</span>
                <span class="s2">&quot;chrX&quot;</span><span class="p">,</span> <span class="n">reference_genome</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">locus</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">reference_genome</span>
            <span class="p">)</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">t_xnonpar</span> <span class="o">=</span> <span class="n">t_x</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">t_x</span><span class="o">.</span><span class="n">locus</span><span class="o">.</span><span class="n">in_x_nonpar</span><span class="p">())</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">t_xnonpar</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> X nonpar sites&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FAILED metric checks for X nonpar sites: no X nonpar sites found!&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check (nhomalt == nhomalt_xx) for X nonpar variants:&quot;</span><span class="p">)</span>
    <span class="n">xx_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xx_metrics</span> <span class="k">if</span> <span class="n">nhomalt_metric</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FAILED check for XX nhomalt metrics: no XX nhomalt metrics found!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking the following XX nhomalt metrics: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xx_metrics</span><span class="p">)</span>

    <span class="n">field_check_expr</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">xx_metrics</span><span class="p">:</span>
        <span class="n">standard_field</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">delimiter</span><span class="si">}</span><span class="s2">XX&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">check_field_left</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">check_field_right</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">standard_field</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">field_check_expr</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check_field_left</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="n">check_field_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">generate_field_check_expr</span><span class="p">(</span>
                <span class="n">t_xnonpar</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_left</span><span class="p">],</span>
                <span class="n">t_xnonpar</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_right</span><span class="p">],</span>
                <span class="s2">&quot;!=&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;agg_func&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">,</span>
            <span class="s2">&quot;display_fields&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="n">check_field_left</span><span class="p">:</span> <span class="n">t_xnonpar</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_left</span><span class="p">],</span>
                    <span class="n">check_field_right</span><span class="p">:</span> <span class="n">t_xnonpar</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">check_field_right</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">),</span>
        <span class="p">}</span>

    <span class="n">generic_field_check_loop</span><span class="p">(</span>
        <span class="n">t_xnonpar</span><span class="p">,</span> <span class="n">field_check_expr</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">function_name</span><span class="o">=</span><span class="s2">&quot;check_sex_chr_metrics&quot;</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="compute_missingness"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.compute_missingness">[docs]</a><span class="k">def</span> <span class="nf">compute_missingness</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
    <span class="n">info_metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">non_info_metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">n_sites</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">missingness_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check amount of missingness in all row annotations.</span>

<span class="sd">    Print metric to sdout if the percentage of metric annotations missingness exceeds the missingness_threshold.</span>

<span class="sd">    :param t: Input MatrixTable or Table.</span>
<span class="sd">    :param info_metrics: List of metrics in info struct of input Table.</span>
<span class="sd">    :param non_info_metrics: List of row annotations minus info struct from input Table.</span>
<span class="sd">    :param n_sites: Number of sites in input Table.</span>
<span class="sd">    :param missingness_threshold: Upper cutoff for allowed amount of missingness.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Missingness threshold (upper cutoff for what is allowed for missingness&quot;</span>
        <span class="s2">&quot; checks): </span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">missingness_threshold</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">metrics_missing</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">info_metrics</span><span class="p">:</span>
        <span class="n">metrics_missing</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">non_info_metrics</span><span class="p">:</span>
        <span class="n">metrics_missing</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="o">**</span><span class="n">metrics_missing</span><span class="p">)))</span>

    <span class="n">n_fail</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">n_missing</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">n_missing</span> <span class="o">/</span> <span class="n">n_sites</span> <span class="o">&gt;</span> <span class="n">missingness_threshold</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;FAILED missingness check for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> sites or </span><span class="si">%.2f%%</span><span class="s2"> missing&quot;</span><span class="p">,</span>
                <span class="n">metric</span><span class="p">,</span>
                <span class="n">n_missing</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">n_missing</span> <span class="o">/</span> <span class="n">n_sites</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">n_fail</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Passed missingness check for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> sites or </span><span class="si">%.2f%%</span><span class="s2"> missing&quot;</span><span class="p">,</span>
                <span class="n">metric</span><span class="p">,</span>
                <span class="n">n_missing</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">n_missing</span> <span class="o">/</span> <span class="n">n_sites</span><span class="p">),</span>
            <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> missing metrics checks failed for top level annotations&quot;</span><span class="p">,</span> <span class="n">n_fail</span><span class="p">)</span></div>


<div class="viewcode-block" id="vcf_field_check"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.vcf_field_check">[docs]</a><span class="k">def</span> <span class="nf">vcf_field_check</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
    <span class="n">header_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span>
    <span class="n">row_annotations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">entry_annotations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hists</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">HISTS</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that all VCF fields and descriptions are present in input Table and VCF header dictionary.</span>

<span class="sd">    :param t: Input MatrixTable or Table to be exported to VCF.</span>
<span class="sd">    :param header_dict: VCF header dictionary.</span>
<span class="sd">    :param row_annotations: List of row annotations in MatrixTable or Table.</span>
<span class="sd">    :param entry_annotations: List of entry annotations to use if running this check on a MatrixTable.</span>
<span class="sd">    :param hists: List of variant histogram annotations. Default is HISTS.</span>
<span class="sd">    :return: Boolean with whether all expected fields and descriptions are present.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hist_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">hists</span><span class="p">:</span>
        <span class="n">hist_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hist</span><span class="si">}</span><span class="s2">_bin_freq&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;dp&quot;</span> <span class="ow">in</span> <span class="n">hist</span><span class="p">:</span>
            <span class="n">hist_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hist</span><span class="si">}</span><span class="s2">_n_larger&quot;</span><span class="p">)</span>

    <span class="n">missing_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">missing_descriptions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;filter&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">entry_annotations</span><span class="p">:</span>
        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
            <span class="n">annots</span> <span class="o">=</span> <span class="n">row_annotations</span>
        <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span>
            <span class="n">annots</span> <span class="o">=</span> <span class="n">entry_annotations</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">annot_t</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">explode_rows</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">annots</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">annot_t</span><span class="o">.</span><span class="n">aggregate_rows</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">collect_as_set</span><span class="p">(</span><span class="n">annot_t</span><span class="o">.</span><span class="n">filters</span><span class="p">)))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">)</span>
                <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">annot_t</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">collect_as_set</span><span class="p">(</span><span class="n">annot_t</span><span class="o">.</span><span class="n">filters</span><span class="p">)))</span>
            <span class="p">)</span>

        <span class="n">temp_missing_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">temp_missing_descriptions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">annots</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> in info field has empty description in VCF header!&quot;</span><span class="p">,</span> <span class="n">field</span>
                    <span class="p">)</span>
                    <span class="n">temp_missing_descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> in info field does not exist in VCF header!&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="c1"># NOTE: END entry is not exported (removed during densify)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">field</span> <span class="o">!=</span> <span class="s2">&quot;END&quot;</span><span class="p">):</span>
                    <span class="n">temp_missing_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="n">missing_fields</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">temp_missing_fields</span><span class="p">)</span>
        <span class="n">missing_descriptions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">temp_missing_descriptions</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_fields</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_descriptions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Some fields are either missing or missing descriptions in the VCF header!&quot;</span>
            <span class="s2">&quot; Please reconcile.&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Missing fields: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">missing_fields</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Missing descriptions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">missing_descriptions</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Passed VCF fields check!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="check_global_and_row_annot_lengths"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.check_global_and_row_annot_lengths">[docs]</a><span class="k">def</span> <span class="nf">check_global_and_row_annot_lengths</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
    <span class="n">row_to_globals_check</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">check_all_rows</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that the lengths of row annotations match the lengths of associated global annotations.</span>

<span class="sd">    :param t: Input MatrixTable or Table.</span>
<span class="sd">    :param row_to_globals_check: Dictionary with row annotation (key) and list of associated global annotations (value) to compare.</span>
<span class="sd">    :param check_all_rows: If True, check all rows in `t`; if False, check only the first row. Default is False.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_all_rows</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">n_rows</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">global_lengths</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">global_field</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">index_globals</span><span class="p">()[</span><span class="n">global_field</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">global_fields</span> <span class="ow">in</span> <span class="n">row_to_globals_check</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">global_field</span> <span class="ow">in</span> <span class="n">global_fields</span>
    <span class="p">}</span>

    <span class="n">row_length_counts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">row_field</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">len</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">row_field</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">row_field</span> <span class="ow">in</span> <span class="n">row_to_globals_check</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">row_field</span><span class="p">,</span> <span class="n">global_fields</span> <span class="ow">in</span> <span class="n">row_to_globals_check</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_all_rows</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Checking length of </span><span class="si">%s</span><span class="s2"> in first row against length of globals: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">row_field</span><span class="p">,</span>
                <span class="n">global_fields</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">row_lengths</span> <span class="o">=</span> <span class="n">row_length_counts</span><span class="p">[</span><span class="n">row_field</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">global_field</span> <span class="ow">in</span> <span class="n">global_fields</span><span class="p">:</span>
            <span class="n">global_len</span> <span class="o">=</span> <span class="n">global_lengths</span><span class="p">[</span><span class="n">global_field</span><span class="p">]</span>
            <span class="n">failed_rows</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="n">count</span> <span class="k">for</span> <span class="n">length</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">row_lengths</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="n">global_len</span>
            <span class="p">)</span>

            <span class="n">outcome</span> <span class="o">=</span> <span class="s2">&quot;Failed&quot;</span> <span class="k">if</span> <span class="n">failed_rows</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;Passed&quot;</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> global and row lengths comparison: Length of </span><span class="si">%s</span><span class="s2"> in&quot;</span>
                <span class="s2">&quot; globals (</span><span class="si">%d</span><span class="s2">) does </span><span class="si">%s</span><span class="s2">match length of </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%d</span><span class="s2"> out of </span><span class="si">%d</span><span class="s2"> rows (row length counter: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">outcome</span><span class="p">,</span>
                <span class="n">global_field</span><span class="p">,</span>
                <span class="n">global_len</span><span class="p">,</span>
                <span class="s2">&quot;NOT &quot;</span> <span class="k">if</span> <span class="n">outcome</span> <span class="o">==</span> <span class="s2">&quot;Failed&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">row_field</span><span class="p">,</span>
                <span class="n">failed_rows</span> <span class="k">if</span> <span class="n">outcome</span> <span class="o">==</span> <span class="s2">&quot;Failed&quot;</span> <span class="k">else</span> <span class="n">n_rows</span><span class="p">,</span>
                <span class="n">n_rows</span><span class="p">,</span>
                <span class="n">row_lengths</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="pprint_global_anns"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.pprint_global_anns">[docs]</a><span class="k">def</span> <span class="nf">pprint_global_anns</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pretty print global annotations.</span>

<span class="sd">    :param t: Input MatrixTable or Table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">global_pprint</span> <span class="o">=</span> <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">g</span><span class="p">])</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">globals</span><span class="p">}</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">global_pprint</span><span class="p">,</span> <span class="n">sort_dicts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="validate_release_t"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.validate_release_t">[docs]</a><span class="k">def</span> <span class="nf">validate_release_t</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">MatrixTable</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
    <span class="n">subsets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span>
    <span class="n">gen_anc_groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">GEN_ANC_GROUPS</span><span class="p">[</span><span class="n">CURRENT_MAJOR_RELEASE</span><span class="p">][</span><span class="s2">&quot;exomes&quot;</span><span class="p">],</span>
    <span class="n">missingness_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">site_gt_check_expr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">BooleanExpression</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">show_percent_sites</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
    <span class="n">metric_first_field</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">sum_metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AC&quot;</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">,</span> <span class="s2">&quot;nhomalt&quot;</span><span class="p">],</span>
    <span class="n">sexes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">SEXES</span><span class="p">,</span>
    <span class="n">groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;adj&quot;</span><span class="p">],</span>
    <span class="n">sample_sum_sets_and_gen_anc_groups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort_order</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">SORT_ORDER</span><span class="p">,</span>
    <span class="n">variant_filter_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RF&quot;</span><span class="p">,</span>
    <span class="n">problematic_regions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lcr&quot;</span><span class="p">,</span> <span class="s2">&quot;segdup&quot;</span><span class="p">,</span> <span class="s2">&quot;nonpar&quot;</span><span class="p">],</span>
    <span class="n">single_filter_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">summarize_variants_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">filters_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">raw_adj_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">subset_freq_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">samples_sum_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">sex_chr_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">missingness_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">pprint_globals</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">row_to_globals_check</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">check_all_rows_in_row_to_global_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a battery of validity checks on a specified group of subsets in a MatrixTable containing variant annotations.</span>

<span class="sd">    Includes:</span>
<span class="sd">    - Summaries of % filter status for different partitions of variants</span>
<span class="sd">    - Histogram outlier bin checks</span>
<span class="sd">    - Checks on AC, AN, and AF annotations</span>
<span class="sd">    - Checks that subgroup annotation values add up to the supergroup annotation values</span>
<span class="sd">    - Checks on sex-chromosome annotations; and summaries of % missingness in variant annotations</span>

<span class="sd">    All annotations must be within an info struct, e.g. t.info.AC-raw.</span>

<span class="sd">    :param t: Input MatrixTable or Table containing variant annotations to check.</span>
<span class="sd">    :param subsets: List of subsets to be checked.</span>
<span class="sd">    :param gen_anc_groups: List of genetic ancestry groups within main callset. Default is GEN_ANC_GROUPS[CURRENT_MAJOR_RELEASE][&quot;exomes&quot;].</span>
<span class="sd">    :param missingness_threshold: Upper cutoff for allowed amount of missingness. Default is 0.5.</span>
<span class="sd">    :param site_gt_check_expr: Optional boolean expression or dictionary of strings and boolean expressions typically used to log how many monoallelic or 100% heterozygous sites are in the Table.</span>
<span class="sd">    :param verbose: If True, display top values of relevant annotations being checked, regardless of whether check conditions are violated; if False, display only top values of relevant annotations if check conditions are violated.</span>
<span class="sd">    :param show_percent_sites: Show percentage of sites that fail checks. Default is False.</span>
<span class="sd">    :param delimiter: String to use as delimiter when making group label combinations. Default is &quot;-&quot;.</span>
<span class="sd">    :param metric_first_field: If True, metric precedes label group, e.g. AC-afr-XY. If False, label group precedes metric, afr-XY-AC. Default is True.</span>
<span class="sd">    :param sum_metrics: List of metrics to sum and compare to annotationed versions and between subsets and entire callset. Default is [&quot;AC&quot;, &quot;AN&quot;, &quot;nhomalt&quot;].</span>
<span class="sd">    :param sexes: List of sexes in table. Default is SEXES.</span>
<span class="sd">    :param groups: List of callstat groups, e.g. &quot;adj&quot; and &quot;raw&quot; contained within the callset. gnomAD does not store the raw callstats for the genetic ancestry group or sex groupings of any subset. Default is [&quot;adj&quot;]</span>
<span class="sd">    :param sample_sum_sets_and_gen_anc_groups: Dict with subset (keys) and genetic ancestry groups within subset (values) for sample sum check.</span>
<span class="sd">    :param sort_order: List containing order to sort label group combinations. Default is SORT_ORDER.</span>
<span class="sd">    :param variant_filter_field: String of variant filtration used in the filters annotation on `ht` (e.g. RF, VQSR, AS_VQSR). Default is &quot;RF&quot;.</span>
<span class="sd">    :param problematic_regions: List of regions considered problematic to run filter check in. Default is [&quot;lcr&quot;, &quot;segdup&quot;, &quot;nonpar&quot;].</span>
<span class="sd">    :param single_filter_count: If True, explode the Table&#39;s filter column and give a supplement total count of each filter. Default is False.</span>
<span class="sd">    :param summarize_variants_check: When true, runs the summarize_variants method. Default is True.</span>
<span class="sd">    :param filters_check: When True, runs the summarize_variant_filters method. Default is True.</span>
<span class="sd">    :param raw_adj_check: When True, runs the check_raw_and_adj_callstats method. Default is True.</span>
<span class="sd">    :param subset_freq_check: When True, runs the compare_subset_freqs method. Default is True.</span>
<span class="sd">    :param samples_sum_check: When True, runs the sum_group_callstats method. Default is True.</span>
<span class="sd">    :param sex_chr_check: When True, runs the check_sex_chr_metricss method. Default is True.</span>
<span class="sd">    :param missingness_check: When True, runs the compute_missingness method. Default is True.</span>
<span class="sd">    :param pprint_globals: When True, Pretty Print the globals of the input Table. Default is True.</span>
<span class="sd">    :param row_to_globals_check: Optional dictionary of globals (keys) and rows (values) to be checked. When passed, function checks that the lengths of the global and row annotations are equal.</span>
<span class="sd">    :param check_all_rows_in_row_to_global_check: If True, check all rows in `t` in `row_to_globals_check`; if False, check only the first row. Default is False.</span>
<span class="sd">    :return: None (stdout display of results from the battery of validity checks).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pprint_globals</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;GLOBALS OF INPUT TABLE:&quot;</span><span class="p">)</span>
        <span class="n">pprint_global_anns</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">row_to_globals_check</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;COMPARE GLOBAL ANNOTATIONS&#39; LENGTHS TO ROW ANNOTATIONS:&quot;</span><span class="p">)</span>
        <span class="n">check_global_and_row_annot_lengths</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">row_to_globals_check</span><span class="p">,</span> <span class="n">check_all_rows_in_row_to_global_check</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">summarize_variants_check</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;BASIC SUMMARY OF INPUT TABLE:&quot;</span><span class="p">)</span>
        <span class="n">summarize_variants</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filters_check</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VARIANT FILTER SUMMARIES:&quot;</span><span class="p">)</span>
        <span class="n">summarize_variant_filters</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">variant_filter_field</span><span class="p">,</span>
            <span class="n">problematic_regions</span><span class="p">,</span>
            <span class="n">single_filter_count</span><span class="p">,</span>
            <span class="n">site_gt_check_expr</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">raw_adj_check</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RAW AND ADJ CHECKS:&quot;</span><span class="p">)</span>
        <span class="n">check_raw_and_adj_callstats</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">subsets</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">,</span> <span class="n">metric_first_field</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">subset_freq_check</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SUBSET FREQUENCY CHECKS:&quot;</span><span class="p">)</span>
        <span class="n">compare_subset_freqs</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">subsets</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">,</span>
            <span class="n">show_percent_sites</span><span class="p">,</span>
            <span class="n">delimiter</span><span class="p">,</span>
            <span class="n">metric_first_field</span><span class="p">,</span>
            <span class="n">sum_metrics</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">samples_sum_check</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CALLSET ANNOTATIONS TO SUM GROUP CHECKS:&quot;</span><span class="p">)</span>
        <span class="n">sum_group_callstats</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">sexes</span><span class="p">,</span>
            <span class="n">subsets</span><span class="p">,</span>
            <span class="n">gen_anc_groups</span><span class="p">,</span>
            <span class="n">groups</span><span class="p">,</span>
            <span class="n">sample_sum_sets_and_gen_anc_groups</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">,</span>
            <span class="n">sort_order</span><span class="p">,</span>
            <span class="n">delimiter</span><span class="p">,</span>
            <span class="n">metric_first_field</span><span class="p">,</span>
            <span class="n">sum_metrics</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">info_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sex_chr_check</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SEX CHROMOSOME ANNOTATION CHECKS:&quot;</span><span class="p">)</span>
        <span class="n">contigs</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">collect_as_set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">locus</span><span class="o">.</span><span class="n">contig</span><span class="p">))</span>
        <span class="n">check_sex_chr_metrics</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">info_metrics</span><span class="p">,</span> <span class="n">contigs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">missingness_check</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MISSINGNESS CHECKS:&quot;</span><span class="p">)</span>
        <span class="n">non_info_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>
        <span class="n">non_info_metrics</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
        <span class="n">n_sites</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">compute_missingness</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">info_metrics</span><span class="p">,</span> <span class="n">non_info_metrics</span><span class="p">,</span> <span class="n">n_sites</span><span class="p">,</span> <span class="n">missingness_threshold</span>
        <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VALIDITY CHECKS COMPLETE&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="count_vep_annotated_variants_per_interval"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.count_vep_annotated_variants_per_interval">[docs]</a><span class="k">def</span> <span class="nf">count_vep_annotated_variants_per_interval</span><span class="p">(</span>
    <span class="n">vep_ht</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span> <span class="n">interval_ht</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the count of VEP annotated variants in `vep_ht` per interval defined by `interval_ht`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        - `vep_ht` must contain the &#39;vep.transcript_consequences&#39; array field, which</span>
<span class="sd">          contains a &#39;biotype&#39; field to determine whether a variant is in a</span>
<span class="sd">          &quot;protein-coding&quot; gene.</span>
<span class="sd">        - `interval_ht` should be indexed by &#39;locus&#39; and contain a &#39;gene_stable_ID&#39;</span>
<span class="sd">          field. For example, an interval Table containing the intervals of</span>
<span class="sd">          protein-coding genes of a specific Ensembl release.</span>

<span class="sd">    The returned Table will have the following fields added:</span>
<span class="sd">        - n_total_variants: The number of total variants in the interval.</span>
<span class="sd">        - n_pcg_variants: The number of variants in the interval that are annotated as</span>
<span class="sd">          &quot;protein-coding&quot;.</span>

<span class="sd">    :param vep_ht: VEP-annotated Table.</span>
<span class="sd">    :param interval_ht: Interval Table.</span>
<span class="sd">    :return: Interval Table with annotations for the counts of total variants and</span>
<span class="sd">        variants annotated as &quot;protein-coding&quot; in biotype.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Counting the number of total variants and protein-coding variants in each&quot;</span>
        <span class="s2">&quot; interval...&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Select the vep_ht and annotate genes that have a matched interval from</span>
    <span class="c1"># the interval_ht and are protein-coding.</span>
    <span class="n">vep_ht</span> <span class="o">=</span> <span class="n">vep_ht</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">gene_stable_ID</span><span class="o">=</span><span class="n">interval_ht</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vep_ht</span><span class="o">.</span><span class="n">locus</span><span class="p">,</span> <span class="n">all_matches</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">gene_stable_ID</span><span class="p">,</span>
        <span class="n">in_pcg</span><span class="o">=</span><span class="n">vep_ht</span><span class="o">.</span><span class="n">vep</span><span class="o">.</span><span class="n">transcript_consequences</span><span class="o">.</span><span class="n">biotype</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;protein_coding&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">vep_ht</span> <span class="o">=</span> <span class="n">vep_ht</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">is_defined</span><span class="p">(</span><span class="n">vep_ht</span><span class="o">.</span><span class="n">gene_stable_ID</span><span class="p">))</span>

    <span class="c1"># Explode the vep_ht by gene_stable_ID.</span>
    <span class="n">vep_ht</span> <span class="o">=</span> <span class="n">vep_ht</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="n">vep_ht</span><span class="o">.</span><span class="n">gene_stable_ID</span><span class="p">)</span>

    <span class="c1"># Count the number of total variants and &quot;protein-coding&quot; variants in each interval.</span>
    <span class="n">count_ht</span> <span class="o">=</span> <span class="n">vep_ht</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">vep_ht</span><span class="o">.</span><span class="n">gene_stable_ID</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
        <span class="n">all_variants</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="n">variants_in_pcg</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">count_where</span><span class="p">(</span><span class="n">vep_ht</span><span class="o">.</span><span class="n">in_pcg</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">interval_ht</span> <span class="o">=</span> <span class="n">interval_ht</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="o">**</span><span class="n">count_ht</span><span class="p">[</span><span class="n">interval_ht</span><span class="o">.</span><span class="n">gene_stable_ID</span><span class="p">])</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checkpointing the counts per interval...&quot;</span><span class="p">)</span>
    <span class="n">interval_ht</span> <span class="o">=</span> <span class="n">interval_ht</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span>
        <span class="n">new_temp_file</span><span class="p">(</span><span class="s2">&quot;validity_checks.vep_count_per_interval&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;ht&quot;</span><span class="p">),</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Genes without variants annotated: &quot;</span><span class="p">)</span>
    <span class="n">gene_sets</span> <span class="o">=</span> <span class="n">interval_ht</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
        <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
            <span class="n">na_genes</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">interval_ht</span><span class="o">.</span><span class="n">variants_in_pcg</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">interval_ht</span><span class="o">.</span><span class="n">variants_in_pcg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">collect_as_set</span><span class="p">(</span><span class="n">interval_ht</span><span class="o">.</span><span class="n">gene_stable_ID</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">partial_pcg_genes</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="p">(</span><span class="n">interval_ht</span><span class="o">.</span><span class="n">all_variants</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">interval_ht</span><span class="o">.</span><span class="n">variants_in_pcg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">interval_ht</span><span class="o">.</span><span class="n">all_variants</span> <span class="o">!=</span> <span class="n">interval_ht</span><span class="o">.</span><span class="n">variants_in_pcg</span><span class="p">),</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">collect_as_set</span><span class="p">(</span><span class="n">interval_ht</span><span class="o">.</span><span class="n">gene_stable_ID</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> gene(s) have no variants annotated as protein-coding in Biotype. It is&quot;</span>
        <span class="s2">&quot; likely these genes are not covered by the variants in &#39;vep_ht&#39;. These&quot;</span>
        <span class="s2">&quot; genes are: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">gene_sets</span><span class="o">.</span><span class="n">na_genes</span><span class="p">),</span>
        <span class="n">gene_sets</span><span class="o">.</span><span class="n">na_genes</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> gene(s) have a subset of variants annotated as protein-coding biotype&quot;</span>
        <span class="s2">&quot; in their defined intervals&quot;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">gene_sets</span><span class="o">.</span><span class="n">partial_pcg_genes</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">interval_ht</span></div>


<div class="viewcode-block" id="check_missingness_of_struct"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.check_missingness_of_struct">[docs]</a><span class="k">def</span> <span class="nf">check_missingness_of_struct</span><span class="p">(</span>
    <span class="n">struct_expr</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">StructExpression</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recursively check the fraction of missing values of all fields within a StructExpression.</span>

<span class="sd">    Either a standalone or nested struct can be provided. If the struct contains an array (or set) of values, the array</span>
<span class="sd">    will be considered missing if it is NA, an empty array, or only has missing elements.</span>

<span class="sd">    :param struct_expr: StructExpression for which to check for missing values.</span>
<span class="sd">    :param prefix: Prefix to append to names of struct fields within the struct_expr.</span>
<span class="sd">    :return: Dictionary mapping field names to their missingness fraction expressions, with nested dictionaries representing any nested structs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">struct_expr</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">StructExpression</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">check_missingness_of_struct</span><span class="p">(</span>
                <span class="n">struct_expr</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">struct_expr</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">struct_expr</span><span class="p">,</span> <span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">ArrayExpression</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">SetExpression</span><span class="p">)):</span>
        <span class="c1"># Count array/set as missing if it is NA, an empty array/set, or only has missing</span>
        <span class="c1"># elements.</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">fraction</span><span class="p">(</span>
            <span class="n">hl</span><span class="o">.</span><span class="n">or_else</span><span class="p">(</span><span class="n">struct_expr</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">fraction</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">is_missing</span><span class="p">(</span><span class="n">struct_expr</span><span class="p">))</span></div>


<div class="viewcode-block" id="flatten_missingness_struct"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.flatten_missingness_struct">[docs]</a><span class="k">def</span> <span class="nf">flatten_missingness_struct</span><span class="p">(</span>
    <span class="n">missingness_struct</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">StructExpression</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recursively flatten and evaluate nested dictionaries of missingness within a Struct.</span>

<span class="sd">    :param missingness_struct: Struct containing dictionaries of missingness values.</span>
<span class="sd">    :return: Dictionary with field names as keys and their evaluated missingness fractions as values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">missingness_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">missingness_struct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Recursively check nested missingness dictionaries and flatten if needed.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">missingness_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">flatten_missingness_struct</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">missingness_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">missingness_dict</span></div>


<div class="viewcode-block" id="unfurl_array_annotations"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.unfurl_array_annotations">[docs]</a><span class="k">def</span> <span class="nf">unfurl_array_annotations</span><span class="p">(</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
    <span class="n">array_meta_dicts</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="s2">&quot;freq_meta&quot;</span><span class="p">},</span>
    <span class="n">sorted_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;subset&quot;</span><span class="p">,</span> <span class="s2">&quot;gen_anc&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unfurl specified arrays of structs into a dictionary of flattened expressions.</span>

<span class="sd">    Array annotations are expected to have corresponding metadata dictionaries defining the content of each array element.</span>
<span class="sd">    All keys in the metadata dictionaries must be defined in the `sorted_keys` list.</span>

<span class="sd">    :param ht: Input Table.</span>
<span class="sd">    :param array_meta_dicts: Dictionary containing the array annotations to unfurl and their corresponding metadata dictionaries. Default is {&#39;freq&#39;: &#39;freq_meta&#39;}.</span>
<span class="sd">    :param sorted_keys: List containing the order in which keys should be flattened. Default is [&quot;subset&quot;, &quot;gen_anc&quot;, &quot;sex&quot;, &quot;group&quot;].</span>
<span class="sd">    :return: Flattened dictionary of unfurled array annotations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expr_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Define function to combine keys for flattening.</span>
    <span class="k">def</span> <span class="nf">_make_key</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Concatenate keys into a new annotation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">meta</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sorted_keys</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">array</span><span class="p">,</span> <span class="n">array_meta</span> <span class="ow">in</span> <span class="n">array_meta_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="n">array_meta</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="n">array_meta</span><span class="p">])</span>

        <span class="c1"># Raise error if any unsuspected keys found.</span>
        <span class="n">meta_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">key</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">array_meta</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">unspecified_keys</span> <span class="o">=</span> <span class="n">meta_keys</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">sorted_keys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unspecified_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected key(s) </span><span class="si">{</span><span class="n">unspecified_keys</span><span class="si">}</span><span class="s2"> in freq_meta, all keys must be defined in the sort order&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Iterate through array_meta and assign each index to a new flattened key</span>
        <span class="c1"># containing all group info.</span>
        <span class="n">index_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">_make_key</span><span class="p">(</span><span class="n">meta</span><span class="p">):</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">array_meta</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ht</span><span class="p">[</span><span class="n">array</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">expr_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ht</span><span class="p">[</span><span class="n">array</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">expr_dict</span></div>


<div class="viewcode-block" id="check_globals_for_retired_terms"><a class="viewcode-back" href="../../../api_reference/assessment/validity_checks.html#gnomad.assessment.validity_checks.check_globals_for_retired_terms">[docs]</a><span class="k">def</span> <span class="nf">check_globals_for_retired_terms</span><span class="p">(</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span> <span class="n">retired_terms</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pop&quot;</span><span class="p">,</span> <span class="s2">&quot;population&quot;</span><span class="p">,</span> <span class="s2">&quot;oth&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">}</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check list of dictionaries to see if the keys in the meta dictionaries contain retired terms.</span>

<span class="sd">    :param ht: Input Table</span>
<span class="sd">    :param retired_terms: Set of retired terms to check for in the global annotations. Default is {&quot;pop&quot;, &quot;population&quot;, &quot;oth&quot;, &quot;other&quot;}.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking globals for retired terms...&quot;</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ht</span><span class="o">.</span><span class="n">globals</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;meta&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">hl</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="n">field</span><span class="p">]):</span>
                <span class="c1"># Check for retired terms in global keys.</span>
                <span class="n">terms_in_global_keys</span> <span class="o">=</span> <span class="n">retired_terms</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms_in_global_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Found retired term(s) </span><span class="si">{</span><span class="n">terms_in_global_keys</span><span class="si">}</span><span class="s2"> in global field keys </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># Checks for retired terms in global values.</span>
                <span class="n">terms_in_global_values</span> <span class="o">=</span> <span class="n">retired_terms</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms_in_global_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Found retired term(s) </span><span class="si">{</span><span class="n">terms_in_global_values</span><span class="si">}</span><span class="s2"> in global field values </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;index_dict&quot;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hl</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="n">field</span><span class="p">])</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">terms_in_global_index</span> <span class="o">=</span> <span class="n">retired_terms</span><span class="o">.</span><span class="n">intersection</span><span class="p">({</span><span class="n">k</span><span class="p">})</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms_in_global_index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Found retired term(s) </span><span class="si">{</span><span class="n">terms_in_global_index</span><span class="si">}</span><span class="s2"> in global index field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">hl</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="n">field</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed retired term check: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Passed retired term check: No retired terms found in globals.&quot;</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>